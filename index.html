<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manufacturing Planner Pro</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/recharts@2.8.0/umd/Recharts.js"></script>
    <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } = Recharts;

        // Initial data
        const defaultUsers = [
            {"username": "superadmin", "password": "admin123", "role": "Super Admin", "firstLogin": false, "lastLogin": null},
            {"username": "admin", "password": "admin123", "role": "Admin", "firstLogin": false, "lastLogin": null},
            {"username": "user", "password": "user123", "role": "User", "firstLogin": false, "lastLogin": null}
        ];

        const initialData = [
            {"process": "Granulation 150 L", "45835": 0, "45836": 0, "45837": 0, "45838": 0, "45839": 0, "45840": 12, "45841": 0, "45842": 0, "45843": 0, "45844": 0, "45845": 0, "45846": 0, "45847": 0, "45848": 0, "total": 12},
            {"process": "Granulation 700 L", "45835": 2, "45836": 6.1, "45837": 0, "45838": 6.1, "45839": 6.1, "45840": 4.1, "45841": 6.1, "45842": 4.15, "45843": 2.05, "45844": 0, "45845": 2.55, "45846": 20.7, "45847": 16.4, "45848": 6.4, "total": 82.65},
            {"process": "Granulation 1400 L", "45835": 0, "45836": 0, "45837": 0, "45838": 0, "45839": 0, "45840": 0, "45841": 0, "45842": 0, "45843": 0, "45844": 0, "45845": 0, "45846": 0, "45847": 0, "45848": 0, "total": 0},
            {"process": "Granulation 1200 L", "45835": 0, "45836": 0, "45837": 0, "45838": 0, "45839": 0, "45840": 0, "45841": 0, "45842": 0, "45843": 0, "45844": 0, "45845": 0, "45846": 0, "45847": 0, "45848": 0, "total": 0},
            {"process": "FBP total", "45835": 1.8, "45836": 1.8, "45837": 0, "45838": 3.65, "45839": 3.65, "45840": 4.45, "45841": 4.45, "45842": 4.45, "45843": 4.45, "45844": 0, "45845": 1.6, "45846": 1.6, "45847": 1.6, "45848": 2.4, "total": 35.85},
            {"process": "Roller Compactor", "45835": 3.15, "45836": 3.15, "45837": 0, "45838": 3.15, "45839": 0, "45840": 0, "45841": 0, "45842": 0, "45843": 0, "45844": 0, "45845": 0, "45846": 1.575, "45847": 3.15, "45848": 6.3, "total": 20.475},
            {"process": "Blending-01", "45835": 0, "45836": 0, "45837": 0, "45838": 0, "45839": 0, "45840": 0, "45841": 0, "45842": 0, "45843": 0, "45844": 0, "45845": 0, "45846": 0, "45847": 0, "45848": 0, "total": 0},
            {"process": "Blending-02", "45835": 0, "45836": 0, "45837": 0, "45838": 0, "45839": 0, "45840": 0, "45841": 0, "45842": 0, "45843": 0, "45844": 0, "45845": 0, "45846": 0, "45847": 0, "45848": 0, "total": 0},
            {"process": "Blending-03", "45835": 0, "45836": 0, "45837": 0, "45838": 0, "45839": 0, "45840": 0, "45841": 0, "45842": 0, "45843": 0, "45844": 0, "45845": 0, "45846": 0, "45847": 0, "45848": 0, "total": 0},
            {"process": "Band sealing", "45835": 3, "45836": 3, "45837": 0, "45838": 3, "45839": 3, "45840": 3, "45841": 2.25, "45842": 4.25, "45843": 3, "45844": 0, "45845": 4.3, "45846": 4.3, "45847": 4.3, "45848": 4.3, "total": 37.7}
        ];

        const initialColumnHeaders = {
            "45835": "Jul 24",
            "45836": "Jul 25",
            "45837": "Jul 26",
            "45838": "Jul 27",
            "45839": "Jul 28",
            "45840": "Jul 29",
            "45841": "Jul 30",
            "45842": "Jul 31",
            "45843": "Aug 01",
            "45844": "Aug 02",
            "45845": "Aug 03",
            "45846": "Aug 04",
            "45847": "Aug 05",
            "45848": "Aug 06"
        };

        // Utility functions
        const validatePassword = (password) => {
            return password.length >= 8 && 
                   /[A-Z]/.test(password) && 
                   /[a-z]/.test(password) && 
                   /\d/.test(password) && 
                   /[!@#$%^&*(),.?":{}|<>]/.test(password);
        };

        const showToast = (message, type = 'info') => {
            const toast = document.createElement('div');
            toast.className = `toast toast--${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.classList.add('toast-hide');
                setTimeout(() => document.body.removeChild(toast), 300);
            }, 3000);
        };

        // Clock Component
        const Clock = () => {
            const [time, setTime] = useState(new Date());

            useEffect(() => {
                const timer = setInterval(() => setTime(new Date()), 1000);
                return () => clearInterval(timer);
            }, []);

            return (
                <div className="clock">
                    {time.toLocaleTimeString()}
                </div>
            );
        };

        // Password Change Modal
        const PasswordChangeModal = ({ user, onPasswordChange, onCancel }) => {
            const [newPassword, setNewPassword] = useState('');
            const [confirmPassword, setConfirmPassword] = useState('');
            const [error, setError] = useState('');
            const [isValid, setIsValid] = useState(false);

            useEffect(() => {
                if (newPassword && confirmPassword) {
                    if (newPassword !== confirmPassword) {
                        setError('Passwords do not match');
                        setIsValid(false);
                    } else if (!validatePassword(newPassword)) {
                        setError('Password must be at least 8 characters with uppercase, lowercase, number, and special character');
                        setIsValid(false);
                    } else {
                        setError('');
                        setIsValid(true);
                    }
                }
            }, [newPassword, confirmPassword]);

            const handleSubmit = (e) => {
                e.preventDefault();
                if (isValid) {
                    onPasswordChange(newPassword);
                }
            };

            return (
                <div className="modal-overlay">
                    <div className="modal">
                        <h2>Change Password</h2>
                        <p>Welcome {user.username}! Please change your password to continue.</p>
                        <form onSubmit={handleSubmit}>
                            <div className="form-group">
                                <label className="form-label">New Password</label>
                                <input
                                    type="password"
                                    className="form-control"
                                    value={newPassword}
                                    onChange={(e) => setNewPassword(e.target.value)}
                                    required
                                />
                            </div>
                            <div className="form-group">
                                <label className="form-label">Confirm Password</label>
                                <input
                                    type="password"
                                    className="form-control"
                                    value={confirmPassword}
                                    onChange={(e) => setConfirmPassword(e.target.value)}
                                    required
                                />
                            </div>
                            {error && <div className="error-message">{error}</div>}
                            <div className="flex gap-8 mt-16">
                                <button type="submit" className="btn btn--primary" disabled={!isValid}>
                                    Change Password
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        // User Management Component
        const UserManagement = ({ currentUser, users, onAddUser, onDeleteUser }) => {
            const [showAddForm, setShowAddForm] = useState(false);
            const [newUser, setNewUser] = useState({ username: '', password: '', role: 'User' });
            const [error, setError] = useState('');

            const handleAddUser = (e) => {
                e.preventDefault();
                if (users.find(u => u.username === newUser.username)) {
                    setError('Username already exists');
                    return;
                }
                if (!validatePassword(newUser.password)) {
                    setError('Password must be at least 8 characters with uppercase, lowercase, number, and special character');
                    return;
                }
                onAddUser({ ...newUser, firstLogin: true, lastLogin: null });
                setNewUser({ username: '', password: '', role: 'User' });
                setShowAddForm(false);
                setError('');
                showToast('User added successfully', 'success');
            };

            const handleDeleteUser = (username) => {
                if (window.confirm(`Are you sure you want to delete user "${username}"?`)) {
                    onDeleteUser(username);
                    showToast('User deleted successfully', 'success');
                }
            };

            return (
                <div className="user-management">
                    <div className="flex justify-between items-center mb-16">
                        <h2>User Management</h2>
                        <button
                            className="btn btn--primary"
                            onClick={() => setShowAddForm(!showAddForm)}
                        >
                            Add User
                        </button>
                    </div>

                    {showAddForm && (
                        <div className="card mb-16">
                            <div className="card__body">
                                <form onSubmit={handleAddUser}>
                                    <div className="form-group">
                                        <label className="form-label">Username</label>
                                        <input
                                            type="text"
                                            className="form-control"
                                            value={newUser.username}
                                            onChange={(e) => setNewUser({...newUser, username: e.target.value})}
                                            required
                                        />
                                    </div>
                                    <div className="form-group">
                                        <label className="form-label">Password</label>
                                        <input
                                            type="password"
                                            className="form-control"
                                            value={newUser.password}
                                            onChange={(e) => setNewUser({...newUser, password: e.target.value})}
                                            required
                                        />
                                    </div>
                                    <div className="form-group">
                                        <label className="form-label">Role</label>
                                        <select
                                            className="form-control"
                                            value={newUser.role}
                                            onChange={(e) => setNewUser({...newUser, role: e.target.value})}
                                        >
                                            <option value="User">User</option>
                                            <option value="Admin">Admin</option>
                                            <option value="Super Admin">Super Admin</option>
                                        </select>
                                    </div>
                                    {error && <div className="error-message">{error}</div>}
                                    <div className="flex gap-8">
                                        <button type="submit" className="btn btn--primary">Add User</button>
                                        <button 
                                            type="button" 
                                            className="btn btn--secondary"
                                            onClick={() => {setShowAddForm(false); setError('');}}
                                        >
                                            Cancel
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}

                    <div className="card">
                        <div className="card__body">
                            <div className="table-container">
                                <table className="data-table">
                                    <thead>
                                        <tr>
                                            <th>Username</th>
                                            <th>Role</th>
                                            <th>Last Login</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {users.map(user => (
                                            <tr key={user.username}>
                                                <td>{user.username}</td>
                                                <td>
                                                    <span className={`status status--${
                                                        user.role === 'Super Admin' ? 'error' : 
                                                        user.role === 'Admin' ? 'warning' : 'info'
                                                    }`}>
                                                        {user.role}
                                                    </span>
                                                </td>
                                                <td>{user.lastLogin ? new Date(user.lastLogin).toLocaleString() : 'Never'}</td>
                                                <td>
                                                    <span className={`status status--${user.firstLogin ? 'warning' : 'success'}`}>
                                                        {user.firstLogin ? 'Password Change Required' : 'Active'}
                                                    </span>
                                                </td>
                                                <td>
                                                    {user.username !== currentUser.username && (
                                                        <button
                                                            className="btn btn--outline btn--sm"
                                                            onClick={() => handleDeleteUser(user.username)}
                                                        >
                                                            Delete
                                                        </button>
                                                    )}
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // Calendar Management Component
        const CalendarManagement = ({ columnHeaders, onUpdateHeaders }) => {
            const [editingHeaders, setEditingHeaders] = useState({...columnHeaders});
            const [hasChanges, setHasChanges] = useState(false);

            const handleHeaderChange = (key, value) => {
                setEditingHeaders({...editingHeaders, [key]: value});
                setHasChanges(true);
            };

            const handleSave = () => {
                onUpdateHeaders(editingHeaders);
                setHasChanges(false);
                showToast('Calendar headers updated successfully', 'success');
            };

            const handleReset = () => {
                setEditingHeaders({...columnHeaders});
                setHasChanges(false);
            };

            return (
                <div className="calendar-management">
                    <div className="flex justify-between items-center mb-16">
                        <h2>Calendar Management</h2>
                        <div className="flex gap-8">
                            <button
                                className="btn btn--primary"
                                onClick={handleSave}
                                disabled={!hasChanges}
                            >
                                Save Changes
                            </button>
                            <button
                                className="btn btn--secondary"
                                onClick={handleReset}
                                disabled={!hasChanges}
                            >
                                Reset
                            </button>
                        </div>
                    </div>

                    <div className="card">
                        <div className="card__body">
                            <p className="mb-16">Edit calendar column headers. You can use alphanumeric values like batch numbers or cleaning schedules.</p>
                            <div className="calendar-headers-grid">
                                {Object.entries(editingHeaders).map(([key, value]) => (
                                    <div key={key} className="form-group">
                                        <label className="form-label">Column {key}</label>
                                        <input
                                            type="text"
                                            className="form-control"
                                            value={value}
                                            onChange={(e) => handleHeaderChange(key, e.target.value)}
                                        />
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // Data Export/Import Component
        const DataManagement = ({ data, onImportData }) => {
            const fileInputRef = useRef(null);

            const handleExport = () => {
                const csv = Papa.unparse(data);
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `manufacturing_data_${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                window.URL.revokeObjectURL(url);
                showToast('Data exported successfully', 'success');
            };

            const handleImport = (event) => {
                const file = event.target.files[0];
                if (file) {
                    Papa.parse(file, {
                        complete: (results) => {
                            try {
                                const importedData = results.data.filter(row => row.process);
                                onImportData(importedData);
                                showToast('Data imported successfully', 'success');
                            } catch (error) {
                                showToast('Error importing data', 'error');
                            }
                        },
                        header: true,
                        skipEmptyLines: true
                    });
                }
                event.target.value = '';
            };

            const handleBackup = () => {
                const backup = {
                    data: JSON.parse(localStorage.getItem('manufacturingData') || '[]'),
                    users: JSON.parse(localStorage.getItem('users') || '[]'),
                    columnHeaders: JSON.parse(localStorage.getItem('columnHeaders') || '{}'),
                    timestamp: new Date().toISOString()
                };
                const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `manufacturing_backup_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                window.URL.revokeObjectURL(url);
                showToast('Backup created successfully', 'success');
            };

            return (
                <div className="data-management">
                    <h2 className="mb-16">Data Management</h2>
                    <div className="card">
                        <div className="card__body">
                            <div className="flex gap-8 flex-wrap">
                                <button className="btn btn--primary" onClick={handleExport}>
                                    Export to CSV
                                </button>
                                <button 
                                    className="btn btn--secondary" 
                                    onClick={() => fileInputRef.current?.click()}
                                >
                                    Import from CSV
                                </button>
                                <button className="btn btn--outline" onClick={handleBackup}>
                                    Create Backup
                                </button>
                            </div>
                            <input
                                ref={fileInputRef}
                                type="file"
                                accept=".csv"
                                onChange={handleImport}
                                style={{ display: 'none' }}
                            />
                        </div>
                    </div>
                </div>
            );
        };

        // Manufacturing Table Component
        const ManufacturingTable = ({ data, columnHeaders, currentUser, onDataChange, onDeleteRow, onAddRow }) => {
            const [editingCell, setEditingCell] = useState(null);
            const [showAddForm, setShowAddForm] = useState(false);
            const [newProcessName, setNewProcessName] = useState('');

            const handleCellChange = (rowIndex, column, value) => {
                if (column === 'process') return;
                
                const numericValue = parseFloat(value) || 0;
                const newData = [...data];
                newData[rowIndex] = { ...newData[rowIndex], [column]: numericValue };
                
                if (column !== 'total') {
                    const total = Object.keys(columnHeaders).reduce((sum, key) => 
                        sum + (newData[rowIndex][key] || 0), 0
                    );
                    newData[rowIndex].total = total;
                }
                
                onDataChange(newData);
                setEditingCell(null);
            };

            const handleDeleteRow = (index) => {
                if (window.confirm('Are you sure you want to delete this equipment?')) {
                    onDeleteRow(index);
                    showToast('Equipment deleted successfully', 'success');
                }
            };

            const handleAddRow = (e) => {
                e.preventDefault();
                if (!newProcessName.trim()) return;
                
                const newRow = { process: newProcessName, total: 0 };
                Object.keys(columnHeaders).forEach(key => {
                    newRow[key] = 0;
                });
                
                onAddRow(newRow);
                setNewProcessName('');
                setShowAddForm(false);
                showToast('Equipment added successfully', 'success');
            };

            const canEdit = currentUser.role === 'Super Admin' || currentUser.role === 'Admin';
            const canDelete = currentUser.role === 'Super Admin';

            return (
                <div className="manufacturing-table">
                    <div className="flex justify-between items-center mb-16">
                        <h2>Manufacturing Schedule</h2>
                        {canDelete && (
                            <button
                                className="btn btn--primary"
                                onClick={() => setShowAddForm(!showAddForm)}
                            >
                                Add Equipment
                            </button>
                        )}
                    </div>

                    {showAddForm && (
                        <div className="card mb-16">
                            <div className="card__body">
                                <form onSubmit={handleAddRow}>
                                    <div className="form-group">
                                        <label className="form-label">Equipment Name</label>
                                        <input
                                            type="text"
                                            className="form-control"
                                            value={newProcessName}
                                            onChange={(e) => setNewProcessName(e.target.value)}
                                            placeholder="Enter equipment name"
                                            required
                                        />
                                    </div>
                                    <div className="flex gap-8">
                                        <button type="submit" className="btn btn--primary">Add Equipment</button>
                                        <button 
                                            type="button" 
                                            className="btn btn--secondary"
                                            onClick={() => setShowAddForm(false)}
                                        >
                                            Cancel
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}

                    <div className="table-container">
                        <table className="data-table">
                            <thead>
                                <tr>
                                    <th className="equipment-column">Equipment</th>
                                    {Object.entries(columnHeaders).map(([key, header]) => (
                                        <th key={key}>{header}</th>
                                    ))}
                                    <th>Total</th>
                                    {canDelete && <th>Actions</th>}
                                </tr>
                            </thead>
                            <tbody>
                                {data.map((row, rowIndex) => (
                                    <tr key={rowIndex}>
                                        <td className="equipment-column font-weight-medium">{row.process}</td>
                                        {Object.keys(columnHeaders).map(column => (
                                            <td key={column}>
                                                {canEdit && editingCell === `${rowIndex}-${column}` ? (
                                                    <input
                                                        type="number"
                                                        step="0.01"
                                                        className="cell-input"
                                                        defaultValue={row[column]}
                                                        onBlur={(e) => handleCellChange(rowIndex, column, e.target.value)}
                                                        onKeyPress={(e) => {
                                                            if (e.key === 'Enter') {
                                                                handleCellChange(rowIndex, column, e.target.value);
                                                            }
                                                        }}
                                                        autoFocus
                                                    />
                                                ) : (
                                                    <span
                                                        className={canEdit ? "editable-cell" : ""}
                                                        onClick={() => canEdit && setEditingCell(`${rowIndex}-${column}`)}
                                                    >
                                                        {row[column]}
                                                    </span>
                                                )}
                                            </td>
                                        ))}
                                        <td className="font-weight-bold">{row.total}</td>
                                        {canDelete && (
                                            <td>
                                                <button
                                                    className="btn btn--outline btn--sm"
                                                    onClick={() => handleDeleteRow(rowIndex)}
                                                >
                                                    Delete
                                                </button>
                                            </td>
                                        )}
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        // Login Component
        const LoginPage = ({ onLogin, onLogoUpload, companyLogo }) => {
            const [credentials, setCredentials] = useState({ username: '', password: '' });
            const [error, setError] = useState('');
            const fileInputRef = useRef(null);

            const handleSubmit = (e) => {
                e.preventDefault();
                const users = JSON.parse(localStorage.getItem('users')) || defaultUsers;
                const user = users.find(u => 
                    u.username === credentials.username && u.password === credentials.password
                );
                
                if (user) {
                    onLogin(user);
                } else {
                    setError('Invalid credentials');
                }
            };

            const handleLogoUpload = (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        onLogoUpload(e.target.result);
                    };
                    reader.readAsDataURL(file);
                }
            };

            return (
                <div className="login-container">
                    <div className="login-card">
                        <div className="login-header">
                            {companyLogo && (
                                <img src={companyLogo} alt="Company Logo" className="login-logo" />
                            )}
                            <h1>Manufacturing Planner Pro</h1>
                            <p>Professional Manufacturing Management System</p>
                        </div>
                        
                        <form onSubmit={handleSubmit} className="login-form">
                            <div className="form-group">
                                <label className="form-label">Username</label>
                                <input
                                    type="text"
                                    className="form-control"
                                    value={credentials.username}
                                    onChange={(e) => setCredentials({...credentials, username: e.target.value})}
                                    required
                                />
                            </div>
                            <div className="form-group">
                                <label className="form-label">Password</label>
                                <input
                                    type="password"
                                    className="form-control"
                                    value={credentials.password}
                                    onChange={(e) => setCredentials({...credentials, password: e.target.value})}
                                    required
                                />
                            </div>
                            {error && <div className="error-message">{error}</div>}
                            <button type="submit" className="btn btn--primary btn--full-width">
                                Sign In
                            </button>
                        </form>

                        <div className="login-footer">
                            <button
                                type="button"
                                className="btn btn--outline btn--sm"
                                onClick={() => fileInputRef.current?.click()}
                            >
                                Upload Company Logo
                            </button>
                            <input
                                ref={fileInputRef}
                                type="file"
                                accept="image/*"
                                onChange={handleLogoUpload}
                                style={{ display: 'none' }}
                            />
                        </div>
                    </div>
                </div>
            );
        };

        // Main App Component
        const App = () => {
            const [currentUser, setCurrentUser] = useState(null);
            const [showPasswordChange, setShowPasswordChange] = useState(false);
            const [activeTab, setActiveTab] = useState('dashboard');
            const [data, setData] = useState([]);
            const [users, setUsers] = useState([]);
            const [columnHeaders, setColumnHeaders] = useState({});
            const [companyLogo, setCompanyLogo] = useState('');
            const [loading, setLoading] = useState(false);

            // Initialize data from localStorage
            useEffect(() => {
                const savedUsers = localStorage.getItem('users');
                const savedData = localStorage.getItem('manufacturingData');
                const savedHeaders = localStorage.getItem('columnHeaders');
                const savedLogo = localStorage.getItem('companyLogo');

                setUsers(savedUsers ? JSON.parse(savedUsers) : defaultUsers);
                setData(savedData ? JSON.parse(savedData) : initialData);
                setColumnHeaders(savedHeaders ? JSON.parse(savedHeaders) : initialColumnHeaders);
                setCompanyLogo(savedLogo || '');
            }, []);

            // Auto-save data every 30 seconds
            useEffect(() => {
                const interval = setInterval(() => {
                    if (data.length > 0) {
                        localStorage.setItem('manufacturingData', JSON.stringify(data));
                        localStorage.setItem('users', JSON.stringify(users));
                        localStorage.setItem('columnHeaders', JSON.stringify(columnHeaders));
                    }
                }, 30000);

                return () => clearInterval(interval);
            }, [data, users, columnHeaders]);

            const handleLogin = (user) => {
                const updatedUsers = users.map(u => 
                    u.username === user.username 
                        ? { ...u, lastLogin: new Date().toISOString() }
                        : u
                );
                setUsers(updatedUsers);
                localStorage.setItem('users', JSON.stringify(updatedUsers));

                if (user.firstLogin) {
                    setCurrentUser(user);
                    setShowPasswordChange(true);
                } else {
                    setCurrentUser(user);
                }
            };

            const handlePasswordChange = (newPassword) => {
                const updatedUsers = users.map(u => 
                    u.username === currentUser.username 
                        ? { ...u, password: newPassword, firstLogin: false }
                        : u
                );
                setUsers(updatedUsers);
                localStorage.setItem('users', JSON.stringify(updatedUsers));
                setShowPasswordChange(false);
                showToast('Password changed successfully', 'success');
            };

            const handleLogout = () => {
                setCurrentUser(null);
                setActiveTab('dashboard');
            };

            const handleLogoUpload = (logoData) => {
                setCompanyLogo(logoData);
                localStorage.setItem('companyLogo', logoData);
                showToast('Logo uploaded successfully', 'success');
            };

            const handleDataChange = (newData) => {
                setData(newData);
                localStorage.setItem('manufacturingData', JSON.stringify(newData));
            };

            const handleAddUser = (newUser) => {
                const updatedUsers = [...users, newUser];
                setUsers(updatedUsers);
                localStorage.setItem('users', JSON.stringify(updatedUsers));
            };

            const handleDeleteUser = (username) => {
                const updatedUsers = users.filter(u => u.username !== username);
                setUsers(updatedUsers);
                localStorage.setItem('users', JSON.stringify(updatedUsers));
            };

            const handleUpdateHeaders = (newHeaders) => {
                setColumnHeaders(newHeaders);
                localStorage.setItem('columnHeaders', JSON.stringify(newHeaders));
            };

            const handleDeleteRow = (index) => {
                const newData = data.filter((_, i) => i !== index);
                handleDataChange(newData);
            };

            const handleAddRow = (newRow) => {
                const newData = [...data, newRow];
                handleDataChange(newData);
            };

            const handleImportData = (importedData) => {
                handleDataChange(importedData);
            };

            if (!currentUser) {
                return (
                    <LoginPage 
                        onLogin={handleLogin} 
                        onLogoUpload={handleLogoUpload}
                        companyLogo={companyLogo}
                    />
                );
            }

            if (showPasswordChange) {
                return (
                    <PasswordChangeModal
                        user={currentUser}
                        onPasswordChange={handlePasswordChange}
                        onCancel={() => setShowPasswordChange(false)}
                    />
                );
            }

            const chartData = data.map(row => ({
                name: row.process,
                value: row.total
            }));

            return (
                <div className="app">
                    <header className="app-header">
                        <div className="header-left">
                            <h1>Manufacturing Planner Pro</h1>
                        </div>
                        <div className="header-center">
                            <Clock />
                        </div>
                        <div className="header-right">
                            {companyLogo && (
                                <img src={companyLogo} alt="Company Logo" className="header-logo" />
                            )}
                            <span className="user-info">
                                Welcome, {currentUser.username} ({currentUser.role})
                            </span>
                            <button className="btn btn--outline btn--sm" onClick={handleLogout}>
                                Logout
                            </button>
                        </div>
                    </header>

                    <nav className="app-nav">
                        <button
                            className={`nav-item ${activeTab === 'dashboard' ? 'active' : ''}`}
                            onClick={() => setActiveTab('dashboard')}
                        >
                            Dashboard
                        </button>
                        <button
                            className={`nav-item ${activeTab === 'schedule' ? 'active' : ''}`}
                            onClick={() => setActiveTab('schedule')}
                        >
                            Schedule
                        </button>
                        {(currentUser.role === 'Super Admin' || currentUser.role === 'Admin') && (
                            <button
                                className={`nav-item ${activeTab === 'calendar' ? 'active' : ''}`}
                                onClick={() => setActiveTab('calendar')}
                            >
                                Calendar
                            </button>
                        )}
                        {currentUser.role === 'Super Admin' && (
                            <button
                                className={`nav-item ${activeTab === 'users' ? 'active' : ''}`}
                                onClick={() => setActiveTab('users')}
                            >
                                Users
                            </button>
                        )}
                        <button
                            className={`nav-item ${activeTab === 'data' ? 'active' : ''}`}
                            onClick={() => setActiveTab('data')}
                        >
                            Data
                        </button>
                    </nav>

                    <main className="app-main">
                        {loading && <div className="loading-spinner">Loading...</div>}
                        
                        {activeTab === 'dashboard' && (
                            <div className="dashboard">
                                <h2 className="mb-16">Production Overview</h2>
                                <div className="dashboard-stats">
                                    <div className="stat-card">
                                        <h3>Total Equipment</h3>
                                        <div className="stat-value">{data.length}</div>
                                    </div>
                                    <div className="stat-card">
                                        <h3>Active Processes</h3>
                                        <div className="stat-value">{data.filter(row => row.total > 0).length}</div>
                                    </div>
                                    <div className="stat-card">
                                        <h3>Total Production</h3>
                                        <div className="stat-value">{data.reduce((sum, row) => sum + row.total, 0).toFixed(2)}</div>
                                    </div>
                                </div>
                                <div className="chart-container" style={{ height: '400px', position: 'relative' }}>
                                    <ResponsiveContainer width="100%" height="100%">
                                        <BarChart data={chartData}>
                                            <CartesianGrid strokeDasharray="3 3" />
                                            <XAxis dataKey="name" angle={-45} textAnchor="end" height={100} />
                                            <YAxis />
                                            <Tooltip />
                                            <Bar dataKey="value" fill="#1FB8CD" />
                                        </BarChart>
                                    </ResponsiveContainer>
                                </div>
                            </div>
                        )}

                        {activeTab === 'schedule' && (
                            <ManufacturingTable
                                data={data}
                                columnHeaders={columnHeaders}
                                currentUser={currentUser}
                                onDataChange={handleDataChange}
                                onDeleteRow={handleDeleteRow}
                                onAddRow={handleAddRow}
                            />
                        )}

                        {activeTab === 'calendar' && (currentUser.role === 'Super Admin' || currentUser.role === 'Admin') && (
                            <CalendarManagement
                                columnHeaders={columnHeaders}
                                onUpdateHeaders={handleUpdateHeaders}
                            />
                        )}

                        {activeTab === 'users' && currentUser.role === 'Super Admin' && (
                            <UserManagement
                                currentUser={currentUser}
                                users={users}
                                onAddUser={handleAddUser}
                                onDeleteUser={handleDeleteUser}
                            />
                        )}

                        {activeTab === 'data' && (
                            <DataManagement
                                data={data}
                                onImportData={handleImportData}
                            />
                        )}
                    </main>
                </div>
            );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
    <script src="app.js"></script>
</body>
</html>